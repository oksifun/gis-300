# Модуль обмена данными с ГИС ЖКХ


Сервис GIS — это комплексное решение для интеграции локальных учетных систем с государственной информационной системой жилищно-коммунального хозяйства (ГИС ЖКХ). Он предназначен для автоматизации процессов обмена данными, упрощения управления объектами ЖКХ и соблюдения требований законодательства Российской Федерации.

---
## Содержание

1. [Введение](#введение)
   - [Что такое ГИС ЖКХ?](#что-такое-гис-жкх)
   - [Описание сервиса](#описание-сервиса)
2. [Предметная область](#предметная-область)
3. [Основные понятия](#основные-понятия)
4. [Структура проекта](#структура-проекта)
5. [Установка соединения](#установка-соединения)
    - [Настройка криптотуннеля](#криптотуннель-по-госту)
    - [Электронная подпись](#электронная-подпись)
    - [Извлечение из ЭЦП](#1-извлечение-ключей-из-usb-донгла)
    - [Преобразование в PEM-формат](#2-преобразование-ключей-в-pem-формат)
    - [Примечания](#3-примечания)
6. [Веб-сервис ГИС ЖКХ](#веб-сервис-гис-жкх)
    - [Работа-с-операциями](#работа-с-операциями)
        - [Операция веб-сервиса](#операция-веб-сервиса)
        - [Принцип выполнения операции](#принцип-выполнения-операции)
        - [Формирование запроса](#формирование-запроса)
        - [Сопоставление идентификаторов](#сопоставление-идентификаторов)
        - [Обработка результата](#обработка-результата)
        - [Завершение операции](#завершение-операции)
    - [Файловый сервис ГИС ЖКХ](#файловый-сервис-гис-жкх)
7. [Сервисы API](#сервисы-api)
    - [Ключевые функции сервиса](#ключевые-функции-сервиса)
    - [Описание классов и методов](#описание-классов-и-методов)
8. [Техническая архитектура](#техническая-архитектура)
    - [Основные компоненты](#основные-компоненты)
    - [Технологический стек](#технологический-стек)


---

# Введение

Модуль предназначен для асинхронного взаимодействия с ГИС ЖКХ, включая отправку, получение и обработку данных. Реализация предусматривает:
- Использование SOAP-сообщений;
- Поддержку операций загрузки и выгрузки данных;
- Автоматизацию работы через задачи _Celery_.


## Что такое ГИС ЖКХ?

ГИС ЖКХ (Государственная информационная система жилищно-коммунального хозяйства) — это федеральная система, предоставляющая доступ к информации о жилищно-коммунальных услугах для граждан, органов власти и организаций.

Система используется для:
- Хранения данных о домах, помещениях, договорах, начислениях и оплатах.
- Контроля за качеством предоставления услуг ЖКХ.
- Обеспечения прозрачности данных для всех участников рынка ЖКХ.
- Автоматизации взаимодействия между организациями ЖКХ, государственными органами и гражданами.

---

# Описание сервиса

## Описание взаимодействия

Обмен ведется в асинхронном режиме:

1. согласно представленным схемам формируется запрос и посылается в ГИС ЖКХ в составе SOAP-сообщения с уникальным идентификатором;
2. по полученному идентификатору квитанции запрашивается результат обработки ГИС ЖКХ сообщения, откуда извлекается результирующий элемент и данные сохраняются.

Реализация асинхронного взаимодействия заключается в создании отдельной задачи (процесса) _Celery_ для каждого этапа обмена. При возникновении критической ошибки в одной задаче, остальные не затрагиваются и продолжают функционирование (кроме последовательных операций).


## Интеграция с ГИС ЖКХ

- Передача данных о домах, помещениях, жильцах договорах, приборах учета и платежных документах.
- Получение данных из ГИС ЖКХ, таких как:
  - Справочники (НСИ).
  - Актуальная информация об объектах.
  - Статус выполнения запросов.

## Обработка данных

- Валидация данных перед отправкой в ГИС ЖКХ.
- Приведение данных к требованиям API ГИС ЖКХ (SOAP/REST).
- Обработка ошибок при работе с ГИС ЖКХ:
  - Анализ и логирование ошибок.
  - Генерация отчетов для упрощения их исправления.

## Асинхронное выполнение задач

- Использование Celery для выполнения долгих задач:
  - Отправка больших объемов данных.
  - Регулярное обновление справочников.
- Очереди задач обеспечивают надежность и масштабируемость.

## Интеграция с локальными учетными системами

- REST API для удобного подключения внешних систем.
- Универсальный механизм для передачи и получения данных:
  - Фильтрация и агрегация данных.
  - Построение отчетов и аналитики.

---

# Предметная область

ГИС ЖКХ — это государственная информационная система жилищно-коммунального хозяйства, включающая данные о домах, жильцах, счетах, приборах учета и других объектах. Модуль разработан для интеграции с этой системой, с учётом следующих особенностей:
- Ограничения на объём данных в одной операции;
- Использование уникальных идентификаторов для каждой операции;
- Шифрование и подпись данных по ГОСТ-алгоритмам.

---

# Основные понятия

1. **Операция**: полный цикл взаимодействия с ГИС ЖКХ.

    Операцией называется полный цикл обмена с ГИС ЖКХ определенным типом данных. В связи с установкой ГИС ЖКХ ограничений на количество элементов в одной операции, нередко приходится разделять запрос на подзапросы, в результате порождаются связанные по идентификатору записи parent_id с "родительской" (первой), операции.


2. **GisRecord**: запись состояния выполнения операции.

    Состояние выполнения хранится в записи об операции (коллекция GisRecord). Фактически, каждая запись - это отдельная операция, хотя она может быть частью большого запроса, разбитого на части. Операции можно возобновлять с места остановки, загрузив данные записи.


3. **GUID**: уникальный идентификатор объекта ГИС ЖКХ.

    Полученные данные ГИС ЖКХ хранятся как идентификаторы (коллекция GUID), называемые также документами идентификаторов. Кроме, непосредственно идентификатора ГИС ЖКХ (выгруженного) объекта, здесь хранится другая информация о сущности ГИС ЖКХ. Как то - уникальный номер, используемый для обмена шаблонами, идентификатор версии сущности, а также текст ошибки, полученной в результате неудачной попытки выгрузки объекта (идентификатор ГИС ЖКХ в этом случае отсутствует). Кроме того, здесь зафиксирована связь сущности ГИС ЖКХ с объектом Системы, что позволяет синхронизировать данные двух систем.


4. **ЭЦП** : Электронная цифровая подпись  
     Электронная цифровая подпись - уникальный код которая хранится в защищённом виде и используется для подписания документов и подтверждения личности.  
     Это уникальный код, который используется для подтверждения личности человека или организации в электронных документах. Она гарантирует, что документ не был изменён после подписания, и подтверждает, кто именно его подписал. Это как ваша рукописная подпись, но в цифровом виде.
---

# Структура проекта

```plaintext
├── api                     # Реализация REST API
│   └── v4                  # 
├── core                    # Основные модули и SOAP клиент
├── models                  # Модели базы данных
├── services                # Логика работы сервисов
├── tasks                   # Асинхронные задачи Celery
├── utils                   # Утилиты для работы с объектами системы
```
---

# Установка соединения


Взаимодействие состоит из следующих частей:

 - [Криптотуннель](#криптотуннель-по-госту). Установка по ГОСТу шифрованного туннеля до серверов ГИС ЖКХ.
 - [Подпись с сертификатом](#подпись-с-сертификатом). Формирование и отправка подписанного XML запроса.

---
## Криптотуннель по ГОСТу


Для установки соединения с промышленным сервером ГИС ЖКХ необходим **шифрованный канал** по алгоритму `ГОСТ-34.11-2012`.

   - Необходимо установить библиотеки stunnel и openssl > 1.1.1

   - Скачать файл библиотеки **gost.so** и положить его по пути /etc/ssl/engines/gost.so
    (Путь можно выбрать иной, его надо будет прописать в настройках ssl)

   - Следует отредактировать файл конфигурации openssl **ssl.cnf**

      >_sudo nano /etc/ssl/openssl.cnf_


Пример файла конфигурации для ssl

```editorconfig
openssl_conf = openssl_config

[openssl_config]
engines = engine_section
ssl_conf = ssl_section

[openssl_def]
engines = engine_section


[engine_section]
gost = gost_section

[gost_section]
engine_id = gost
default_algorithms = ALL
CRYPT_PARAMS = id-Gost28147-89-CryptoPro-A-ParamSet
dynamic_path = /etc/ssl/engines/gost.so
#default_algorithms = CIPHERS, DIGESTS, PKEY, PKEY_CRYPTO, PKEY_ASN1

[ssl_section]
system_default = protocol_section

[protocol_section]
MinProtocol = TLSv1
CipherString = DEFAULT@SECLEVEL=1

```

> Для установки соединения с тестовыми серверами может использоваться незащищенный канал.

---

## Электронная подпись


Само сообщение дополнительно должно включать в себя **электронную подпись** бизнес данных в формате `ГОСТ-34.11-2001`  
(версия 2012 так и не была внедрена).

> :warning: Необходимость подписи данных также распространяется на тестовые сервера ГИС ЖКХ, но разрешено использовать тестовые сертификаты.

### На текущий момент необходима ЭЦП на имя генерального директора.
  
Есть предпосылки на использование МЧД, но пока не реализовано  
МЧД (Машиночитаемая доверенность) — это электронный аналог обычной доверенности в формате XML-файла.

---

## Извлечение сертификата и ключа из ЭЦП

Для подписания данных в формате `ГОСТ-34.11-2001` потребуется сертификат и закрытый ключ в формате PKCS12 (.pem).  

Если используется USB-донгл (например, Rutoken), выполните следующие шаги:

## 1. Извлечение ключей из USB-донгла
На Windows с помощью приложения *Tokens.exe* экспортируйте ключи из токена. В результате вы получите файлы вида:  
```
primary.key, masks.key, name.key, header.key
```
   - Скачайте архив с утилитой Tokens и запустите её.  
     ___Найти можно в интеренте по запросу Tokens_CertFix.zip или Tokens.exe___  
     Это безопасная программа для копирования файлов ключа ЭЦП на флешку.
   - Выберите «Экспорт» в строке с ключом руководителя.  
     Появится возможность выбрать папку для сохранения  
     ___Если на токене несколько ключей и вы не знаете нужный, запустите КриптоПро и на вкладке «Сервис» запустите «Просмотреть сертификаты в контейнере». Нажмите «Обзор», выберите ключ на токене и посмотрите информацию по нему.___

---

## 2. Преобразование ключей в PEM-формат
Для преобразования файлов ключей используйте Docker-образ `sokolko/export-cryptopro-cert`.  

### Шаги:
1. **Скопируйте контейнер ключей на съемный диск.**  
Скопируйте полученную директорию с файлами `*.key` на компьютер с установленным Docker.  

2. **Загрузите Docker-образ:**
   ```bash
   sudo docker pull sokolko/export-cryptopro-cert
   ```

3. **Экспортируйте ключи в PEM-формат:**
   Выполните команду в терминале, указав каталог с ключами и PIN-код токена:
   ```bash
   sudo docker run --rm -v $PWD:/data sokolko/export-cryptopro-cert CONTAINER.000 123
   ```
   - **CONTAINER.000** — директория с файлами `*.key`.  
   - **123** — PIN-код вашего токена.

4. **Сохраните PEM-данные:**
   Вывод PEM-данных появится в терминале. Для сохранения используйте перенаправление вывода:  
   ```bash
   sudo docker run --rm -v $PWD:/data sokolko/export-cryptopro-cert CONTAINER.000 123 > cert_and_key.pem
   ```

---

## 3. Примечания
- На тестовых серверах ГИС ЖКХ разрешено использовать тестовые сертификаты.  
- Если PIN-код неизвестен, скорее всего  установлен по умолчанию `123456` или `1234567890` или вовсе его нет (то есть не надо его указывать).
- Сертификаты, бибилиоткеки и конфигурационные файлы для использования хранятся в папке gis -> ```__docker__```
- Если вытащить закрытую часть ключа, по каким-либо причинам, не получается , 
то есть вариант работы с ключом «Рутокен ЭЦП» напрямую вставив его непосредственно в . 

## Полезные ссылки:
- [Исходный код утилиты: export-cryptopro-cert](https://github.com/s-sokolko/export-cryptopro-cert-docker)  
- [Дополнительные инструменты: get-cpcert](https://github.com/kov-serg/get-cpcert)



# Веб-сервис ГИС ЖКХ
Веб-сервис - это несколько схожих по назначению операций, имеющих общую точку доступа (API).

Сервисы ГИС ЖКХ делятся на:
* общие (часто имеющие суффикс "Common") - не привязанные к поставщику информации;
* частные - содержащие операции, выполняемые от лица поставщика информации.

> :warning: Для работы с частными сервисами каждое сообщение должно содержать идентификатор поставщика информации - orgPPAGUID.

Для корректной работы все сервисы должны быть унаследованы от базового класса _WebService_:
```python
class OrgRegistryCommon(WebService):
    """Асинхронный сервис обмена сведениями о поставщиках информации"""

    TARGET_NAMESPACE = 'organizations-registry-common'  # отличается от названия модуля
    IS_COMMON = True  # сервис с анонимными операциями
```
Чувствительное к регистру название класса используется как часть (обычно перед "Async") имени конечной точки сервиса или, для нестандартных адресов, как ключ словаря `ENDPOINT_PATHS`.
```xml
    <soap:address location="https://api.dom.gosuslugi.ru/ext-bus-org-registry-common-service/services/OrgRegistryCommonAsync"/>
```
Название модуля (файла) класса сервиса используется как название пространства имен при загрузке WSDL/XSD-схем сервиса или переопределяется значением атрибута класса `TARGET_NAMESPACE`.
```xml
    <xs:import namespace="http://dom.gosuslugi.ru/schema/integration/organizations-registry-common/"/>
```
Стандартный шаблон адреса конечной точки сервиса:
```
http(s)://server:port/ext-bus-[название модуля]-service/services/[название класса]Async
```

---

## Операция веб-сервиса

Операции реализованы в виде классов, содержащихся в классе сервиса. Это обязательное условие позволяет передавать операциям общие для всех параметры сервиса. Выделяются два основных типа/класса операций, являющихся расширениями базового _AsyncOperation_:

* _ExportOperation_ - операция выгрузки данных из ГИС ЖКХ
* _ImportOperation_ - операция загрузки данных в ГИС ЖКХ

> :warning: Направления в названиях выполняющих операции задач **инвертированы**, для соответствия функции с точки зрения Системы!
> 
> Например, задача import_provider_data выполняет операцию exportOrgRegistry и загружает из ГИС ЖКХ данные организаций.
```python
class OrgRegistryCommon(WebService):
    ...
    class exportOrgRegistry(ExportOperation):
        """Экспорт сведений из реестра организаций"""

        VERSION = "10.0.2.1"  # версия (схем) запроса
        GET_STATE_DELAY = [2, 5, 10, 30, 60]  # ожидание перед запросом состояния обработки
```
Название класса операции используется как имя операции в схеме сервиса и не может быть переопределено с помощью атрибутов:
```xml
<wsdl:operation name="exportOrgRegistry">
	<soap:operation soapAction="urn:exportOrgRegistry"/>
	...
</wsdl:operation>
```
Обязательным атрибутом класса операции является `VERSION` - версия (схем) элемента запроса, начиная с которой поддерживается совместимость. Значение может быть найдено в схеме сервиса:
```xml
    <xs:attribute ref="base:version" use="required" fixed="10.0.2.1"/>
```
Атрибут `GET_STATE_DELAY` задает задержку в секундах перед следующим запросом состояния (и результата) обработки ГИС ЖКХ отправленного запроса. Может быть переопределен для отдельной операции, по умолчанию имеет рекомендованное значение:
```python
    GET_STATE_DELAY = [5, 10, 30, 60, 120, 300, 900, 1800, 3600, 7200, 14400, 21600, 36000]  # 24 часа - макс. время обработки запроса
```
Атрибут `IS_ANONYMOUS` определяется для анонимных (без поставщика информации) операций в частном (не Common) сервисе:
```python
    IS_ANONYMOUS: bool = True  # анонимная (без дома) операция
```
Для операции типа _ImportOperation_, а также доработанной для сервиса _HouseManagementOperation_, введены дополнительные параметры выполнения:
```python
class importAccountData(HouseManagementOperation):
    """
    Передать данные лицевых счетов
    """
    VERSION = "10.0.1.1"
    ELEMENT_LIMIT = 100  # ограничение ГИС ЖКХ

    REQUIREMENTS = {'LegalEntity': 50, 'Area': 90}  # признаки с % требуемых ид-ов операции
```
Обязательный атрибут `ELEMENT_LIMIT` устанавливает выгружаемое за раз количество объектов. Может быть меньше установленного ГИС ЖКХ ограничения на количество элементов запроса:
```xml
    <xs:element name="Account" maxOccurs="100">
```
Атрибут `REQUIREMENTS` становится обязательным при добавлении в логику операции требуемых для выполнения идентификаторов/данных ГИС ЖКХ. В примере выше, для передачи данных лицевых счетов требуются идентификаторы не менее 50% владеющих недвижимостью юр. лиц (LegalTenant) и как минимум 90% помещений (Area). Процентные показатели подлежат публичному согласованию.

Другие переопределяемые параметры выполнения операции можно найти в базовом классе AsyncOperation.

---
## Принцип выполнения операции

Для выполнения операции нужно создать экземпляр ее класса, передав идентификаторы поставщика информации (Provider.id) и участвующего в операции дома (House.id) в метод инициализации операции (`__init__`).

> :warning: Для анонимной операции передавать идентификаторы не нужно.

Также при создании экземпляра можно передать дополнительные параметры выполнения, имеющие приоритет над установленными (атрибутами) в классе.
```python
    _import = Bills.importPaymentDocumentData(provider_id, house_id, update_existing=False)  # только отсутствующие (без идентификаторов)
```
После создания экземпляра операции, его необходимо "исполнить". В качестве аргументов метода исполнения (`__call__`) могут выступать идентификаторы выгружаемых объектов и/или подготовленные элементы запроса операции:
```python
    _import(*accrual_ids,
        DocDate=doc_date,  # изымается из запроса
        Month=period.month, Year=period.year,
        ConfirmAmountsCorrect=True)  # фиксированное True
```
В случае превышения ограничения на количество элементов запроса (ELEMENT_LIMIT), переданные идентификаторы объектов (accrual_ids) будут распределены между несколькими порожденными (от первой) операциями и выгружены последовательно. Параллельная выгрузка распределенных идентификаторов приведет к высокой нагрузке на дисковую и сетевую системы сервера, поэтому не используется.

Метод операции `prepare` может использоваться для предварительной обработки "сырых" данных запроса, например для разделения выгружаемых данных по типу:
```python
def prepare(self, *tenant_ids: ObjectId):
    """
    Выгрузить в ГИС ЖКХ раздельно (по направлению платежа) ЛС
    """
    typed_account_ids: dict = get_typed_account_ids(  # из Accrual
        self.provider_id, self.house_id, *tenant_ids
    )  # распределяем ЛС по типам (КУ, КР,...)

    for account_type, account_ids in typed_account_ids.items():  # : set
        # подготавливаемый тип ЛС передается как часть данных запроса
        super().prepare(*account_ids, AccountType=account_type)
```
---

## Формирование запроса

Для получения или отправки данных в ГИС ЖКХ необходимо сформировать запрос, что выполняет автоматически запущенная после исполнения операции задача.

Запрос формируется в виде словаря со строковыми ключами - названиями элементов запроса (как в схеме) и значениями в формате Python, после чего автоматически конвертируется в SOAP-представление перед отправкой.

Перед формированием всегда выполняется метод `_request` класса операции, возвращающий основу для будущего запроса (или пустой словарь). Переопределив этот метод можно, к примеру, извлечь не предназначенные для отправки в ГИС ЖКХ, но необходимые для формирования запроса данные:
```python
def _request(self) -> dict:
    """
    Подготовить данные запроса операции
    """
    request_data: dict = super()._request()  # копия данных запроса

    self._doc_date = request_data.pop('DocDate', None)
    assert self._doc_date, "Дата документа отсутствует в запросе"

    return request_data
```
Формирование данных запроса выполняется в методе `_compose` класса операции, который необходимо переопределить:
```python
def _compose(self) -> dict:
    """
    Сформировать данные запроса операции
    """
    ...
    return dict(PaymentInformation=payment_information,  # Множественное
        PaymentDocument=payment_documents)  # Множественное
```
В результате наложения на основу (_request) сформированных данных (_compose) получается соответсвующий схеме ГИС ЖКХ запрос:
```xml
<xs:element name="importPaymentDocumentRequest">
    <xs:element name="ConfirmAmountsCorrect" type="xs:boolean" fixed="true" minOccurs="0">...</xs:element>
    <xs:element ref="base:Month">...</xs:element>
    <xs:element ref="base:Year">...</xs:element>
    <xs:element name="PaymentInformation" maxOccurs="unbounded">
    <xs:element name="PaymentDocument" maxOccurs="500">...</xs:element>
    ...
</xs:element>
```

---

## Сопоставление идентификаторов

В процессе формирования запроса крайне важно сопоставить идентификаторы участвующих в операции объектов. Сохранение результатов производится только для сопоставленных идентификаторов!
Для сопоставления необходимо получить (загрузить и создать несуществующие) документы идентификаторов (GUID) методом экземпляра операции `mapped_guids`:
```python
    # получаем идентификаторы ГИС ЖКХ начислений (платежных документов)
    self._accrual_guids = self.mapped_guids('Accrual', *self.object_ids)
```
Список подлежащих выгрузке в ГИС ЖКХ (идентификаторов) объектов возвращается свойством `object_ids` операции. Данный список содержит не превышающее ограничение операции количество идентификаторов, для которых необходимо сформировать данные запроса.

При формировании запроса и (позже) сохранении полученных данных, следует использовать метод операции `failure` для фиксирования ошибки в данных объекта:
```python
    if accrual['doc']['status'] not in CONDUCTED_STATUSES:  # ready,edit
        self.failure(accrual_guid, "Начисление не подготовлено (не проведено)")
        return  # пропускаем непроведенное начисление
```
Если объект не подлежит выгрузке по объективной причине (без ошибки), то его можно исключить из сопоставления методом `unmap`:
```python
    if not accrual_guid.unique and not accrual_guid.error:  # не загружен и без ошибки?
        self._unmap(accrual_guid)  # отменяем сохранение данных ГИС ЖКХ
```
Отсутствующие в полученных данные могут быть выгружены в ГИС ЖКХ последующей операцией. Для постановки объекта в очередь на выгрузку существует метод `missing` операции:
```python
    self.missing(guid)  # подлежит выгрузке после сохранения
```
---

## Обработка результата

После обработки данных запроса в виде SOAP-сообщения, ГИС ЖКХ хранит результаты и возвращает их также в виде SOAP-сообщения по идентификатору квитанции, полученному после отправки запроса.
Извлечение результатов и обработка ошибок выполняются автоматически  методом `_parse` операции, после чего полученные данные перенаправляются в метод `_store` (может быть переопределен при выгрузке и должен при загрузке):
```python
def _store(self, import_results: list):
    """
    Сохранить полученный идентификатор (с данными) ГИС ЖКХ
    """
    for result in import_results:
        guid: GUID = self._mapped_guids[result.TransportGUID]  # : str

        self.success(guid, result.GUID,  # идентификатор сущности ГИС ЖКХ
            unique=result.UniqueNumber,  # Уникальный реестровый номер
            updated=result.UpdateDate)  # Дата модификации  # Обязательное
```
Следует обратить внимание на словарь **_mapped_guids**, заполняемый автоматически сопоставленными идентификаторами перед сохранением данных. Ключами являются транспортные идентификаторы в виде строк, значения - документы коллекции GUID.

Для сохранения полученных данных (идентификатора) ГИС ЖКХ объекта используется метод *success* операции. Первым аргументом передается сопоставленный документ идентификатора (GUID), далее необязательные идентификаторы сущности ГИС ЖКХ (корневой, версии), данные - уникальный и специфический номер сущности, дата и время обновления.

---
## Завершение операции

После обработки результата, операция может начать выполнение последующей (в очереди) операции, если таковая была назначена.
Для операций загрузки, последующей может стать операция выгрузки в ГИС ЖКХ, если найдены не выгруженные данные и установлен соответствующий параметр (export_missing). В этом случае будет предпринята попытка выполнения метода **_import** операции, предназначенного для выгрузки отсутствующих данных:
```python
def _import(self):

    _import = HouseManagement.importAccountData(  # выгружаем в ГИС ЖКХ
        self.provider_id, self.house_id,  # лицевые счета (жильцов) дома
        update_existing=False  # отсутствующие (без идентификаторов)
    ).follow(self)  # ставим в очередь за текущей

    _import.prepare(*self.missing_ids)  # подготавливаем данные запроса

    raise MissingWarning("Потребовалась последующая выгрузка"
        f" {len(self.missing_ids)} отсутствующих в ГИС ЖКХ ЛС")
```
> :warning: Обязательным условием является завершение текущей операции с предупреждением **MissingWarning**, иначе она не будет связана с последующей и исполнения не последует.

---
## Последовательность выполнения

Операция может пребывать в одном из следующих состояний - `GIS_RECORD_STATUS_CHOICES`:

* **Создана** новая - первичная проверка и сохранение параметров операции
* **Подготовка** к выполнению - формирование данных запроса операции
* **Выполняется** ГИС ЖКХ - поставлена (в очередь) на обработку
* **Обработка** результата - извлечение и сохранение полученных данных
* **Завершена** успешно - результаты выполнения операции сохранены
* **Выполнена** с предупреждениями - операция завершена с оговорками
* **Не выполнена** с ошибкой - операция не выполнена по причине ошибки
* **Отложена** до определенного момента - будет выполнена или отменена
* **Отменена** автоматически или вручную - операция не будет выполнена

Запрос на получение данных из ГИС ЖКХ может быть отправлен сколь угодно раз, в том числе параллельно, без особых последствий.

Не имеет смысла отправлять один запрос на создание данных в ГИС ЖКХ многократно, т.к. операции ставятся в очередь обработки и после выполнения первой, для всех последующих будут возвращены ошибки о дублировании данных.
 
> :warning: При внесении изменений в уже выгруженные данные, все операции в очереди выполнятся последовательно и в ГИС ЖКХ будут созданы многочисленные **версии** данных, актуальной из которых считается последняя созданная.

Для большинства операция требуются идентификаторы сущностей ГИС ЖКХ, полученные в процессе выполнения других операций.

Для _importPaymentDocumentData_ - выгрузки платежных документов (начислений) требуются:
* _exportHouseData_ или _importHouseUOData_ - идентификаторы помещений (дома);
* _exportAccountData_ или _importAccountData_ - идентификаторы лицевых счетов (жильцов);
* _exportDataProviderNsiItem_ или _importAdditionalServices_ и _importMunicipalServices_ и _importGeneralNeedsMunicipalResource_ - идентифкаторы указываемых услуг;
* _exportCAChData_ или _importCharterData_ - срок представления (выставления) платежных документов.

Для _importAccountData_ - выгрузки данных лицевых счетов (жильцов) требуются:
* _exportOrgRegistry_ - идентификаторы юр. лиц, собственников помещений;
* _exportHouseData_ или _importHouseUOData_ - идентификаторы помещений (дома).

Для _importMeteringDeviceValues_ - выгрузки показаний приборов учета требуются:
* _exportCAChData_ или _importCharterData_ - сроки передачи показаний индивидуальных и общих приборов учета;
* _exportMeteringDeviceData_ или _importMeteringDeviceData_ - идентификаторы приборов учета.

Для _importMeteringDeviceData_ - выгрузки данных приборов учета требуются:
* _exportHouseData_ или _importHouseUOData_ - идентификаторы помещений (дома);
* _exportAccountData_ или _importAccountData_ - идентификаторы лицевых счетов (жильцов).

> :warning: Абсолютно для всех операций требуются идентификаторы элементов общих справочников, загружаемые операцией _exportNsiItem_.

Реализован механизм выстраивания цепочек из операций, не являющихся "подзапросами" текущей.
Данный механизм позволяет производить загрузку отсутствующих, но необходимых для выполнения операции идентификаторов и автоматизировать процесс обмена.
Это достигается за счет установки особого состояния и сохранения идентификатора последующей операции методом `follow` / `lead`.
```python
def _load_entity_guids(self, entities: dict) -> dict:
    """
    Загрузить идентификаторы ГИС ЖКХ юр. лиц
    """
    entity_guids: dict = self.required_guids('LegalEntity', *entities)
    
    if self.required(entity_guids, entities):
        _export = OrgRegistryCommon.exportOrgRegistry()  # данные орг-ии
        self.follow(_export)  # ставим текущую операцию в очередь
    
        entity_props: dict = {entity_id: props for entity_id, props
            in entities.items() if not entity_guids.get(entity_id)}
    
        _export.legal_entities(entity_props)  # выполняем операцию
    
        # запись об операции сохраняется при выходе из контекста
        raise CancelException("Операция отложена до завершения"
            " загрузки идентификаторов ГИС ЖКХ юр. лиц(а)")
    
    return entity_guids
```

> :warning: Последующая операция выполняется исключительно после успешного завершения предшествующей. В случае ошибки в процессе выполнения, все последующий (зависящие от результата предшествующей) операции выполнены не будут.
---

## Файловый сервис ГИС ЖКХ

Обмен файлами с ГИС ЖКХ осуществляется по протоколу **HTTP 1.1**, где информация о файле содержаться в заголовках (headers), а бинарные данные - в теле (content) отправляемого сообщения.

Максимальный объем отправляемых в одном сообщении данных составляет **5 Мб**, однако поддерживается обмен частями в рамках так называемой **сессии**, при этом максимальный размер файла достигает **1 Гб**.

Для создания сессии передачи данных в ГИС ЖКХ отправляется запрос `POST` с информацией о файле. Отправка данных файла выполняется методом `PUT` протокола, в заголовке которого указывается полученный идентификатор сессии. Если размер файла менее 5 Мб, то отправка выполняется за одну операцию без создания сессии.

Для получения файла из ГИС ЖКХ необходимо отправить запрос `GET` с его идентификатором. Данный идентификатор сразу возвращается после выгрузки небольшого файла или совпадает с идентификатором сессии при выгрузке частями.

Получить информацию о файле - о количестве выгруженных частей, о контексте, где он хранится можно методом `HEAD` протокола.

**Контекст хранения** - это своего рода раздел файловой системы ГИС ЖКХ. Для различных по своему назначению (вне зависимости от типа) файлов предоставляются специфические контексты, например в "agreements" хранятся договоры управления/ресурсоснабжения и уставы.

Все файловые операции реализованы методами сервиса _FileStore_.

---

# Сервисы API

## Ключевые функции сервиса

### Основные классы и их методы

Сервис реализует несколько ViewSet-классов для работы с API:


- [GisOperationViewSet](#gisoperationviewset) — основной класс для выполнения операций над объектами ГИС ЖКХ
- [GisTaskViewSet](#gistaskviewset) — управление задачами ГИС.
- [GisRecordViewSet](#gisrecordviewset) — обработка записей операций.
- [FullRecordViewSet](#fullrecordviewset) — работа с детализированными записями операций.
- [GisGuidViewSet](#gisguidviewset) — управление идентификаторами объектов ГИС ЖКХ.
- [GisQueuedViewSet](#gisqueuedviewset) — управление очередями объектов для выгрузки.
- [HouseProvidersViewSet](#houseprovidersviewset) — получение списка управляющих организаций.
- [GisProviderNSIViewSet](#gisprovidernsiviewset) — работа с частными справочниками.


### Функциональные возможности

1. Выгрузка и загрузка данных:
   - Лицевые счета (тенанты).
   - Общие и частные справочники.
   - Показания приборов учёта.
   - Уставы и договоры управления.
   - Платёжные документы.

2. Архивация данных.
3. Обработка операций с данными (создание, изменение, удаление).

---

## Описание классов и методов

### GisOperationViewSet

**Описание**: Этот класс является основным для выполнения операций над объектами ГИС ЖКХ. Он предоставляет методы для управления данными домов, помещений, лицевых счетов, справочников и платёжных документов.

**Основные методы:**

1. **`send_operation_request`**
   - Отправляет запрос на выполнение операции.
   - Принимает параметр `record_id` для идентификации записи.
   - Пример использования:

     ```python
     @staticmethod
     def send_operation_request(request):
         serialized_request = RecordIdSerializer(data=request.data)
         record_id = serialized_request.get_param('record_id')

         from app.gis.tasks.async_operation import send_request
         send_request.delay(record_id, True)  # форсированный запуск операции

         return JsonResponse(data={'message': f"Выполняется отправка запроса операции {record_id}"})
     ```

2. **`get_operation_result`**
   - Получает результат выполнения операции.
   - Пример:

     ```python
     @staticmethod
     def get_operation_result(request):
         serialized_request = RecordIdSerializer(data=request.data)
         record_id = serialized_request.get_param('record_id')

         from app.gis.tasks.async_operation import fetch_result
         fetch_result.delay(record_id, True)

         return JsonResponse(data={'message': f"Выполняется запрос результата операции {record_id}"})
     ```

3. **`import_houses`**
   - Загружает данные домов и помещений из ГИС ЖКХ.

4. **`export_houses`**
   - Выгружает данные домов и помещений в ГИС ЖКХ.

5. **`import_provider_tenants`**
   - Загружает лицевые счета жильцов домов.

6. **`export_provider_tenants`**
   - Выгружает лицевые счета жильцов в ГИС ЖКХ.

7. **`import_provider_documents`**
   - Загружает уставы или договоры управления организаций.

8. **`export_provider_documents`**
   - Выгружает уставы или договоры управления организаций.

9. **`import_provider_meters`**
   - Загружает приборы учета организаций.

10. **`export_provider_meters`**  
    - Выгружает приборы учета организаций.

11. **`import_readings`** и **`export_readings`**
    - Работают с показаниями приборов учёта (загрузка/выгрузка).

12. **`export_pd`** и **`withdraw_pd`**
    - Управляют платёжными документами: выгрузка и отзыв.

13. **`import_common_nsi`**
    - Загружает общие справочники. 
14. **`import_group_nsi`**
    - Загружает группы справочников.



### GisTaskViewSet

Класс для управления задачами ГИС ЖКХ.

- **`get_queryset`**: Возвращает задачи, связанные с текущим пользователем.
  
  ```python
  def get_queryset(self) -> QuerySet:
      task_query = {
          'name': {'$ne': 'gis.scheduled'},
      }
      request_auth = RequestAuth(self.request)
      if request_auth.is_slave():
          task_query['providers'] = request_auth.get_provider_id()
      return GisTask.objects(__raw__=task_query).order_by('-saved')
  ```

- **`serializer_class`**: Использует `GisTaskSerializer` для сериализации данных.

### GisRecordViewSet

Класс для работы с записями операций.

- **`get_queryset`**: Возвращает записи операций для заданного пользователя.
- **`actual_time`**: Возвращает текущую временную метку с учетом заданного интервала (по умолчанию 96 часов).
- **`actual_date`**: Аналогично `actual_time`, но для недельного интервала.

### FullRecordViewSet

Класс для получения детализированных записей операций.

- **`get_queryset`**: Аналогичен `GisRecordViewSet` с дополнительной детализацией данных.

### GisGuidViewSet

Класс для управления GUID объектов ГИС ЖКХ.

- **`create`**: Создаёт запись с идентификатором объекта для выгрузки в ГИС ЖКХ.
- **`object_url`**: Возвращает URL-адрес объекта на основании его GUID.
- **`get_queryset`**: Получает все GUID объектов.

Пример `create`:

```python
@permission_validator
def create(self, request, *args, **kwargs):
    object_id = ObjectId(request.data['object_id'])
    tag = request.data['tag']

    if not object_id or not tag:
        return Response(status=HTTP_400_BAD_REQUEST, data={
            'error': "Отсутствует идентификатор объекта"
        })

    provider_id = RequestAuth(self.request).get_provider_id()
    # Дальнейшая обработка объекта...
```



### GisQueuedViewSet

- Управляет очередями объектов для выгрузки.
- **`get_queryset`**: Возвращает объекты, которые ожидают выгрузки в ГИС ЖКХ.

### HouseProvidersViewSet

- Получает список управляющих организаций.
- **`list`**: Возвращает JSON-ответ со списком организаций, управляющих домами.

### GisProviderNSIViewSet

- Работает с частными справочниками.
- **`list`**: Возвращает данные о частных справочниках, отсутствующих и доступных справочниках услуг.
---

**Примечания:**
- Большинство методов используют асинхронные задачи (Celery).
- Все методы проверяют права доступа через `RequestAuth` и декоратор `permission_validator`.

---