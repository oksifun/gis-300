### О рассылке уведомлений/квитанций и подписках/отписках

Квитанции/уведомления (дальше КУ) рассылаются у организаций, 
у которых включены соответсвующие настройки тем жителям, которые
явно не отписались от рассылки. Триггером является появление трех оплат
равным по сумме начислениям (истоки логики берутся от автоплатежей).

#### Модели и поля учавствующие в построении логики рассылки

- Provider
    
    ```
    mailing: {
        slip: Boolean,
        notify: Boolean
    }
    ```

- Tenant, Account

    - `email_notify`: Boolean - Получать уведомления по почте?
    - `email_slip`: Boolean - Получать квитанции по почте?
    
    Также у жителя используется `BillSendingMixin`, который добавляет
    вложенное поле настроек `b_settings` для контроля отправки по
    направленяим (мы же не хотим отправлять повторно одни и те же КУ
    при каждом вызове функции!)

- UnsubscribeReason

    Модель для ведения статистики отписок
    
    
#### Запуск

Входная таска во все это дело (как и для автоплатежей) - `run_auto_pay_search` (great_white_shark).
Далее уже создается задача `run_bills_sending`, непосредственно связанная 
с поиском рецепиентов и отправкой КУ. `send_bills_notifications_to_tenant` - отправка уведомлений
о выпуске квитанции.
Дополнительно проверяется, есть ли у провайдера настройка отправки файлов квитанций на e-mail.
Если такая настройка существует, то создается дополнительная таска `send_bills_files_to_tenant`

Шаблоны хранятся в _backend/templates/jinja/mail_ и подключаются через `get_mail_templates`.


#### Управление подпиской

Управление настройками рассылки производится через ЛКЖ, 
а также через публичные страницы на которые ведут ссылки из письма 
(страница настройки подписки есть, но не используются из-за технических сложностей).

Контроллер управления рассылками называется `TenantSubscribeManagerViewSet`.

В письме есть ссылка на отписку, она направляет на страничку `/public/#/unsubscribe/` 
вместе с передачей 3 параметров: 

- `account` - ID жителя
- `number` - номер ЛС
- `type` - от чего отписываемся (либо slips, либо notifies)

Далее FE перенаправляет запрос на `TenantSubscribeManagerViewSet`
c этими параметрами и причиной отписки. Пример:
```
POST /api/v4/public/email/<ID жителя>/unsubscribe/<номер ЛС>/
```
```python
{
    "type": "notifies",
    "reason": "Надоело это терпеть!"
}
```
Далее происходит отписка от указанного типа рассылки и сохраняется причина 
в кол. `UnsubscribeReason`


#### Тесты

Под миксин и отправку написан тест `TestBillSending`. Так что нужно учитывать, 
если производятся какие-то изменения в логике их нужно учесть и в тесте.