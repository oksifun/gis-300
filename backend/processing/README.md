Процессинг
=========================================================================

Модуль worker
-------------------------------------------------------------------------

Модуль **worker** в пакете processing предназначен для запуска процессинговых
процессинговых задач и управления их статусами.

Все выполняемые задачи должны наследовать общий интерфейс класса
***processing.models.tasks.Task***, и реализовывать метод ***process()***,
содержащий логику решения задачи.

Обработчик забирает задачи, находящиеся в статусе CREATED,
если аттрибут delayed не определен, или если значение в нем меньше текущего времени.

В момент присвоения задачи обработчик устанавливает задаче статус
**WORK_IN_PROGRESS**, и аттрибут **worker_pid** в соответствии
со своим идентификатором.

Перед выполнением метода ***process()*** обработчик сохраняет текущее время
в аттрибут **started** задачи, и сохраняет задачу.

После окончания работы обработчик устанавливает аттрибут задачи
**worker_pid** в **None** и сохраняет задачу.

Установка всех прочих аттрибутов задачи, в том числе и статусов отличных
от **WORK_IN_PROGRESS** должна происходить в методе ***process()*** каждой
отдельной задачи.

#### Запуск ####

Обработчик процессинга может быть запущен двумя способами:
* запуск модуля из командной строки
* импорт класса Worker в стронний код и вызов метода ***Worker.start()***

Обработчик принимает следующие аргументы:

* **db**: строка с именем базы данных
(**Обязательный параметр**)
* **queues**: список с именами обрабатываемых очередей, разделенных пробелом
(**Обязательный параметр**)
* **host**: хост, на котором располагается базы данных
(по умолчанию ***localhost***)
* **port**: порт подключения к базе данных
(по умолчанию **27017**)
* **pid**: уникальный идентификатор процесса обработчика
(по умолчанию будет сгенерирован **uuid1**)

При запуске через вызов ***Worker.start()*** параметр **queues** передается
как **queue_names** и должен быть списком строк с именами очередей.

Примеры запуска обработчика из командной строки:

    worker.py --db tasks --queues general glavstroy

    worker.py --db tasks --queues general --host xenon.c300.me --port 27017 --pid WORKER-1


Модуль locks
---------------------------------------------------------------------------

Модуль **locks**, вместе с моделями, расположенными в ***.models.lock***,
предназначены для контроля блокировок ресурсов, используемых в тасках.
Блокировки должны устанавливаться во избежание одновременного выполнения
задач, относящихся к одному аккаунту.

В настоящий момент реализованы блокировки для аккаунтов.

Лок аккаунтов задачей приобретается при помощи метода
***acquire_accounts_task_locks(task, accounts)***, где:
* **task** - объект задачи, для которого будет приобретена блокировка
* **accounts** - список объектов аккаунтов,
которые будут отмечены заблокированными

Если приобретение блокировок прошло успешно, будет возвращен список
объектов блокировок, в противном случае будет возвращен **False**.

Блокировка может быть приобретена, только если отсутствуют блокировки
других задач для всех объектов в списке. Если же задача пытается приобрести
блокировку на список объектов, частькоторы уже принадлежат ей, а часть
не имеют блокировки, то блокировка пройдет успешно, и будет возвращен
список всех блокировок, существующих для данной задачи.

После любого окончания работы алгоритма задачи
блокировки должны быть сняты задачей самостоятельно,
используя метод ***release()*** самих блокировок.

##### Пример #####

    accounts = [Account(
        number=str(i + 100),
        settings=Settings(),
        has_access=True,
        news_count=0,
        delivery_disabled=True,
        _type='Tenant',
        is_privileged=True,
        is_priviledged=True,
        is_super=True,
    ) for i in range(5)]

    task = Task(
        queue='TEST_QUEUE',
        created=datetime.now(),
        status=TaskStatus.CREATED
    )

    for a in accounts:
        a.save()

    task.save()

    locks = acquire_accounts_task_locks(task=task, accounts=accounts)

    print('Task logic here')

    for lock in locks:
        lock.release()

Для автоматического снятия блокировок можно использовать менеджер контекста
***AccountLockContext(task, accounts)***:

    with AccountLockContext(self, [self.tenant]) as locks:
        if not locks:
            self._set_delay()
            return

    # locks released here

***Менеджер контекста для блокировок не должен быть вложенным в другой
с такой же задачей, это приведет к некорректному снятию блокировок!***

Модуль tornsync
--------------------------------------------------------------------------

Модуль **tornsync** предназначен для запуска синхронного кода из tornado-корутин.

##### Пример: #####

    from processing.tornsync import tornsync

    def sync(*args, **kwargs):
        # some code
        print('run syncronous function with arguments:', args, kwargs)

    yield tornsync(create_request_task, 1, kw=2)